FROM debian:stable-slim as build
RUN apt-get update -y && apt-get install -y \
  automake \
  build-essential \
  g++ \
  git \
  jq \
  libffi-dev \
  libghc-postgresql-libpq-dev \
  libgmp-dev \
  libncursesw5 \
  libpq-dev \
  libssl-dev \
  libsystemd-dev \
  libtinfo-dev \
  libtool\
  make\
  pkg-config \
  tmux \
  wget \
  zlib1g-dev \
  autoconf \
  libicu-dev \
  gawk \
  libghc-text-icu-dev \
  curl
ENV PATH="/root/.cabal/bin:/root/.ghcup/bin:/root/.local/bin:$PATH"
ENV LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
ENV PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
RUN ldconfig
RUN wget https://downloads.haskell.org/~cabal/cabal-install-3.10.1.0/cabal-install-3.10.1.0-x86_64-linux-ubuntu20_04.tar.xz \
    && tar -xf cabal-install-3.10.1.0-x86_64-linux-ubuntu20_04.tar.xz \
    && rm cabal-install-3.10.1.0-x86_64-linux-ubuntu20_04.tar.xz \
    && mkdir -p ~/.local/bin \
    && mv cabal ~/.local/bin/ \
    && cabal update && cabal --version
RUN wget https://downloads.haskell.org/ghc/8.10.7/ghc-8.10.7-x86_64-deb9-linux.tar.xz \
    && tar -xf ghc-8.10.7-x86_64-deb9-linux.tar.xz \
    && rm ghc-8.10.7-x86_64-deb9-linux.tar.xz \
    && cd ghc-8.10.7 \
    && ./configure \
    && make install \
    && cd / \
    && rm -rf /ghc-8.10.7
RUN groupadd -g 1001 cardano
RUN useradd -rm -d /home/cardano -s /bin/bash -g 1001 -G sudo -u 1001 cardano
RUN mkdir /home/cardano/cdbsync
RUN mkdir /home/cardano/ipc
RUN mkdir /home/cardano/cardano-db-sync
RUN git clone https://github.com/input-output-hk/libsodium && cd libsodium && git checkout $(curl -L https://github.com/input-output-hk/iohk-nix/releases/latest/download/INFO | awk '$1 == "debian.libsodium-vrf.deb" { rev = gensub(/.*-(.*)\.deb/, "\\1", "g", $2); print rev }') && ./autogen.sh && ./configure && make && make check && make install
RUN mkdir secp256k1-sources && cd secp256k1-sources && git clone https://github.com/bitcoin-core/secp256k1.git && cd secp256k1 && git checkout $(curl -L https://github.com/input-output-hk/iohk-nix/releases/latest/download/INFO | awk '$1 == "debian.libsecp256k1.deb" { rev = gensub(/.*-(.*)\.deb/, "\\1", "g", $2); print rev }') && ./autogen.sh && ./configure --prefix=/usr --enable-module-schnorrsig --enable-experimental && make && make check && make install
ENV LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH" \
    PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
ARG VERSION
RUN echo "Building tags/$VERSION..." 
RUN touch cabal.project.local
COPY . .
RUN cabal update \
    && cabal configure --with-compiler=ghc-8.10.7 \
    && ls -ltra \
    && echo "package cardano-crypto-praos" >>  cabal.project.local \
    && echo "flags: -external-libsodium-vrf" >>  cabal.project.local 
RUN cabal build all \
    && cp -p dist-newstyle/build/x86_64-linux/ghc-8.10.7/cardano-db-sync-*/build/cardano-db-sync/cardano-db-sync /root/.local/bin/
FROM debian:stable-slim
ENV LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
ENV PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
RUN ldconfig
COPY --from=build /root/.local/bin/ /bin/
COPY --from=build /usr/local/lib/ /lib/
RUN apt-get update && apt-get install git postgresql libpq-dev libghc-postgresql-libpq-dev -y
ARG VERSION
RUN mkdir /home/cardano
RUN cd /home/cardano  \
    && git clone https://github.com/input-output-hk/cardano-db-sync.git 
ARG NODE_VERSION
RUN cd /home/cardano  \
    && git clone https://github.com/input-output-hk/cardano-node.git 
RUN apt-get install -y automake build-essential pkg-config libffi-dev libgmp-dev libssl-dev libtinfo-dev libsystemd-dev zlib1g-dev make g++ tmux git jq wget libncursesw5 libtool autoconf libsqlite3-dev m4 ca-certificates gcc libc6-dev curl gawk
RUN git clone https://github.com/input-output-hk/libsodium && cd libsodium && git checkout $(curl -L https://github.com/input-output-hk/iohk-nix/releases/latest/download/INFO | awk '$1 == "debian.libsodium-vrf.deb" { rev = gensub(/.*-(.*)\.deb/, "\\1", "g", $2); print rev }') && ./autogen.sh && ./configure && make && make check && make install
RUN mkdir secp256k1-sources && cd secp256k1-sources && git clone https://github.com/bitcoin-core/secp256k1.git && cd secp256k1 && git checkout $(curl -L https://github.com/input-output-hk/iohk-nix/releases/latest/download/INFO | awk '$1 == "debian.libsecp256k1.deb" { rev = gensub(/.*-(.*)\.deb/, "\\1", "g", $2); print rev }') && ./autogen.sh && ./configure --prefix=/usr --enable-module-schnorrsig --enable-experimental && make && make check && make install
#BASE64 ENCODED DIRTY SOLUTION TO IMPLEMENT A QUICK BASH SCRIPT TO READ THE CONF FILE
RUN cd /home/cardano && echo aWYgWyAkTkVUV09SSyA9ICJtYWlubmV0IiBdOyB0aGVuIApleHBvcnQgQ09ORj0iLi9jYXJkYW5vLWRiLXN5bmMvY29uZmlnL21haW5uZXQueWFtbCI7IApmaTsgCmlmIFsgJE5FVFdPUksgPSAicHJlcHJvZCIgXTsgdGhlbiAKZXhwb3J0IENPTkY9Ii4vY2FyZGFuby1kYi1zeW5jL2NvbmZpZy9wcmVwcm9kLnlhbWwiOyAKZmk7CmlmIFsgJE5FVFdPUksgPSAicHJldmlldyIgXTsgdGhlbiAKZXhwb3J0IENPTkY9Ii4vY2FyZGFuby1kYi1zeW5jL2NvbmZpZy9wcmV2aWV3LnlhbWwiOyAKZmk7CmlmIFsgJE5FVFdPUksgPSAic2FuY2hvbmV0IiBdOyB0aGVuIApleHBvcnQgQ09ORj0iLi9jYXJkYW5vLWRiLXN5bmMvY29uZmlnL3NhbmNob25ldC55YW1sIjsgCmZpOwoKCg== | base64 --decode > getConf.sh && chmod +x getConf.sh
RUN  git clone https://github.com/input-output-hk/cardano-configurations.git /cardano-configurations
#BASE64 ENCODED DIRTY SOLUTION TO IMPLEMENT A QUICK CONFIG YAML FILE INTO CARDANO DB SYNC
RUN echo IyBFeHBsb3JlciBEQiBOb2RlIGNvbmZpZ3VyYXRpb24KCk5ldHdvcmtOYW1lOiBtYWlubmV0CgpFbmFibGVMb2dNZXRyaWNzOiBGYWxzZQpFbmFibGVMb2dnaW5nOiBUcnVlCgpQcm90b2NvbDogQ2FyZGFubwoKIyBUaGUgY29uZmlnIGZpbGUgZm9yIHRoZSBub2RlIHdlIGFyZSBjb25uZWN0aW5nIHRvLiBJZiB0aGlzIGlzIG5vdCB0aGUgY29ycmVjdAojIGNvbmZpZywgaXQgd2lsbCBsaWtlbHkgbGVhZCB0byBkYi1zeW5jIHRocm93aW5nIHVwIHdlaXJkIGVycm9yIG1lc3NhZ2VzIGZyb20KIyB0aGUgY29uc2Vuc3VzIGxheWVyLgojIFRoZSBwYXRoIHRvIHRoZSBub2RlIGNvbmZpZyBmaWxlIGlzIHJlbGF0aXZlIHRvIHRoaXMgY29uZmlnIGZpbGUuCk5vZGVDb25maWdGaWxlOiAvY2FyZGFuby1jb25maWd1cmF0aW9ucy9uZXR3b3JrL21haW5uZXQvY2FyZGFuby1ub2RlL2NvbmZpZy5qc29uCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIExvZ2dpbmcgY29uZmlndXJhdGlvbiBmb2xsb3dzLgoKIyBnbG9iYWwgZmlsdGVyOyBtZXNzYWdlcyBtdXN0IGhhdmUgYXQgbGVhc3QgdGhpcyBzZXZlcml0eSB0byBwYXNzOgptaW5TZXZlcml0eTogSW5mbwoKIyBnbG9iYWwgZmlsZSByb3RhdGlvbiBzZXR0aW5nczoKcm90YXRpb246CiAgcnBMb2dMaW1pdEJ5dGVzOiA1MDAwMDAwCiAgcnBLZWVwRmlsZXNOdW06ICAxMAogIHJwTWF4QWdlSG91cnM6ICAgMjQKCiMgdGhlc2UgYmFja2VuZHMgYXJlIGluaXRpYWxpemVkOgpzZXR1cEJhY2tlbmRzOgogIC0gQWdncmVnYXRpb25CSwogIC0gS2F0aXBCSwogICMgLSBFZGl0b3JCSwogICMgLSBFS0dWaWV3QksKCiMgaWYgbm90IGluZGljYXRlZCBvdGhlcndpc2UsIHRoZW4gbWVzc2FnZXMgYXJlIHBhc3NlZCB0byB0aGVzZSBiYWNrZW5kczoKZGVmYXVsdEJhY2tlbmRzOgogIC0gS2F0aXBCSwoKIyBpZiB3YW50ZWQsIHRoZSBHVUkgaXMgbGlzdGVuaW5nIG9uIHRoaXMgcG9ydDoKIyBoYXNHVUk6IDEyNzg3CgojIGlmIHdhbnRlZCwgdGhlIEVLRyBpbnRlcmZhY2UgaXMgbGlzdGVuaW5nIG9uIHRoaXMgcG9ydDoKIyBoYXNFS0c6IDEyNzg4CgojIGhlcmUgd2Ugc2V0IHVwIG91dHB1dHMgb2YgbG9nZ2luZyBpbiAna2F0aXAnOgpzZXR1cFNjcmliZXM6CiAgLSBzY0tpbmQ6IFN0ZG91dFNLCiAgICBzY05hbWU6IHN0ZG91dAogICAgc2NGb3JtYXQ6IFNjVGV4dAogICAgc2NSb3RhdGlvbjogbnVsbAoKIyBpZiBub3QgaW5kaWNhdGVkIG90aGVyd2lzZSwgdGhlbiBsb2cgb3V0cHV0IGlzIGRpcmVjdGVkIHRvIHRoaXM6CmRlZmF1bHRTY3JpYmVzOgogIC0gLSBTdGRvdXRTSwogICAgLSBzdGRvdXQKCiMgbW9yZSBvcHRpb25zIHdoaWNoIGNhbiBiZSBwYXNzZWQgYXMga2V5LXZhbHVlIHBhaXJzOgpvcHRpb25zOgogIGNmb2tleToKICAgIHZhbHVlOiAiUmVsZWFzZS0xLjAuMCIKICBtYXBTdWJ0cmFjZToKICAgIGJlbmNobWFyazoKICAgICAgY29udGVudHM6CiAgICAgICAgLSBHaGNSdHNTdGF0cwogICAgICAgIC0gTW9ub3RvbmljQ2xvY2sKICAgICAgc3VidHJhY2U6IE9ic2VydmFibGVUcmFjZQogICAgJyNla2d2aWV3JzoKICAgICAgY29udGVudHM6CiAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICBjb250ZW50czogJ2NhcmRhbm8uZXBvY2gtdmFsaWRhdGlvbi5iZW5jaG1hcmsnCiAgICAgICAgLSAtIHRhZzogQ29udGFpbnMKICAgICAgICAgICAgY29udGVudHM6IC5tb25vY2xvY2suYmFzaWMuCiAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICBjb250ZW50czogJ2NhcmRhbm8uZXBvY2gtdmFsaWRhdGlvbi5iZW5jaG1hcmsnCiAgICAgICAgLSAtIHRhZzogQ29udGFpbnMKICAgICAgICAgICAgY29udGVudHM6IGRpZmYuUlRTLmNwdU5zLnRpbWVkLgogICAgICAtIC0gdGFnOiBTdGFydHNXaXRoCiAgICAgICAgICBjb250ZW50czogJyNla2d2aWV3LiNhZ2dyZWdhdGlvbi5jYXJkYW5vLmVwb2NoLXZhbGlkYXRpb24uYmVuY2htYXJrJwogICAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICAgIGNvbnRlbnRzOiBkaWZmLlJUUy5nY051bS50aW1lZC4KICAgICAgc3VidHJhY2U6IEZpbHRlclRyYWNlCiAgICAnY2FyZGFuby5lcG9jaC12YWxpZGF0aW9uLnV0eG8tc3RhdHMnOgogICAgICAjIENoYW5nZSB0aGUgYHN1YnRyYWNlYCB2YWx1ZSB0byBgTmV1dHJhbGAgaW4gb3JkZXIgdG8gbG9nCiAgICAgICMgYFVUeE9gLXJlbGF0ZWQgbWVzc2FnZXMgZHVyaW5nIGVwb2NoIHZhbGlkYXRpb24uCiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnI21lc3NhZ2Vjb3VudGVycy5hZ2dyZWdhdGlvbic6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnI21lc3NhZ2Vjb3VudGVycy5la2d2aWV3JzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICcjbWVzc2FnZWNvdW50ZXJzLnN3aXRjaGJvYXJkJzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICcjbWVzc2FnZWNvdW50ZXJzLmthdGlwJzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICcjbWVzc2FnZWNvdW50ZXJzLm1vbml0b3JpbmcnOgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogICAgJ2NhcmRhbm8uI21lc3NhZ2Vjb3VudGVycy5hZ2dyZWdhdGlvbic6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnY2FyZGFuby4jbWVzc2FnZWNvdW50ZXJzLmVrZ3ZpZXcnOgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogICAgJ2NhcmRhbm8uI21lc3NhZ2Vjb3VudGVycy5zd2l0Y2hib2FyZCc6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnY2FyZGFuby4jbWVzc2FnZWNvdW50ZXJzLmthdGlwJzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICdjYXJkYW5vLiNtZXNzYWdlY291bnRlcnMubW9uaXRvcmluZyc6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgbWFwQmFja2VuZHM6CiAgICBjYXJkYW5vLmVwb2NoLXZhbGlkYXRpb24uYmVuY2htYXJrOgogICAgICAtIEFnZ3JlZ2F0aW9uQksKICAgICcjYWdncmVnYXRpb24uY2FyZGFuby5lcG9jaC12YWxpZGF0aW9uLmJlbmNobWFyayc6CiAgICAgIC0gRUtHVmlld0JLCiAgbWFwU2V2ZXJpdHk6CiAgICBkYi1zeW5jLW5vZGUuU3Vic2NyaXB0aW9uOiBFcnJvcgogICAgZGItc3luYy1ub2RlLk11eDogRXJyb3IKICAgIGRiLXN5bmMtbm9kZTogSW5mbw== | base64 --decode > /home/cardano/cardano-db-sync/config/mainnet.yaml
RUN echo IyBFeHBsb3JlciBEQiBOb2RlIGNvbmZpZ3VyYXRpb24KCk5ldHdvcmtOYW1lOiBwcmVwcm9kCgpFbmFibGVMb2dNZXRyaWNzOiBGYWxzZQpFbmFibGVMb2dnaW5nOiBUcnVlCgpQcm90b2NvbDogQ2FyZGFubwoKIyBUaGUgY29uZmlnIGZpbGUgZm9yIHRoZSBub2RlIHdlIGFyZSBjb25uZWN0aW5nIHRvLiBJZiB0aGlzIGlzIG5vdCB0aGUgY29ycmVjdAojIGNvbmZpZywgaXQgd2lsbCBsaWtlbHkgbGVhZCB0byBkYi1zeW5jIHRocm93aW5nIHVwIHdlaXJkIGVycm9yIG1lc3NhZ2VzIGZyb20KIyB0aGUgY29uc2Vuc3VzIGxheWVyLgojIFRoZSBwYXRoIHRvIHRoZSBub2RlIGNvbmZpZyBmaWxlIGlzIHJlbGF0aXZlIHRvIHRoaXMgY29uZmlnIGZpbGUuCk5vZGVDb25maWdGaWxlOiAvY2FyZGFuby1jb25maWd1cmF0aW9ucy9uZXR3b3JrL3ByZXByb2QvY2FyZGFuby1ub2RlL2NvbmZpZy5qc29uCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIExvZ2dpbmcgY29uZmlndXJhdGlvbiBmb2xsb3dzLgoKIyBnbG9iYWwgZmlsdGVyOyBtZXNzYWdlcyBtdXN0IGhhdmUgYXQgbGVhc3QgdGhpcyBzZXZlcml0eSB0byBwYXNzOgptaW5TZXZlcml0eTogSW5mbwoKIyBnbG9iYWwgZmlsZSByb3RhdGlvbiBzZXR0aW5nczoKcm90YXRpb246CiAgcnBMb2dMaW1pdEJ5dGVzOiA1MDAwMDAwCiAgcnBLZWVwRmlsZXNOdW06ICAxMAogIHJwTWF4QWdlSG91cnM6ICAgMjQKCiMgdGhlc2UgYmFja2VuZHMgYXJlIGluaXRpYWxpemVkOgpzZXR1cEJhY2tlbmRzOgogIC0gQWdncmVnYXRpb25CSwogIC0gS2F0aXBCSwogICMgLSBFZGl0b3JCSwogICMgLSBFS0dWaWV3QksKCiMgaWYgbm90IGluZGljYXRlZCBvdGhlcndpc2UsIHRoZW4gbWVzc2FnZXMgYXJlIHBhc3NlZCB0byB0aGVzZSBiYWNrZW5kczoKZGVmYXVsdEJhY2tlbmRzOgogIC0gS2F0aXBCSwoKIyBpZiB3YW50ZWQsIHRoZSBHVUkgaXMgbGlzdGVuaW5nIG9uIHRoaXMgcG9ydDoKIyBoYXNHVUk6IDEyNzg3CgojIGlmIHdhbnRlZCwgdGhlIEVLRyBpbnRlcmZhY2UgaXMgbGlzdGVuaW5nIG9uIHRoaXMgcG9ydDoKIyBoYXNFS0c6IDEyNzg4CgojIGhlcmUgd2Ugc2V0IHVwIG91dHB1dHMgb2YgbG9nZ2luZyBpbiAna2F0aXAnOgpzZXR1cFNjcmliZXM6CiAgLSBzY0tpbmQ6IFN0ZG91dFNLCiAgICBzY05hbWU6IHN0ZG91dAogICAgc2NGb3JtYXQ6IFNjVGV4dAogICAgc2NSb3RhdGlvbjogbnVsbAoKIyBpZiBub3QgaW5kaWNhdGVkIG90aGVyd2lzZSwgdGhlbiBsb2cgb3V0cHV0IGlzIGRpcmVjdGVkIHRvIHRoaXM6CmRlZmF1bHRTY3JpYmVzOgogIC0gLSBTdGRvdXRTSwogICAgLSBzdGRvdXQKCiMgbW9yZSBvcHRpb25zIHdoaWNoIGNhbiBiZSBwYXNzZWQgYXMga2V5LXZhbHVlIHBhaXJzOgpvcHRpb25zOgogIGNmb2tleToKICAgIHZhbHVlOiAiUmVsZWFzZS0xLjAuMCIKICBtYXBTdWJ0cmFjZToKICAgIGJlbmNobWFyazoKICAgICAgY29udGVudHM6CiAgICAgICAgLSBHaGNSdHNTdGF0cwogICAgICAgIC0gTW9ub3RvbmljQ2xvY2sKICAgICAgc3VidHJhY2U6IE9ic2VydmFibGVUcmFjZQogICAgJyNla2d2aWV3JzoKICAgICAgY29udGVudHM6CiAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICBjb250ZW50czogJ2NhcmRhbm8uZXBvY2gtdmFsaWRhdGlvbi5iZW5jaG1hcmsnCiAgICAgICAgLSAtIHRhZzogQ29udGFpbnMKICAgICAgICAgICAgY29udGVudHM6IC5tb25vY2xvY2suYmFzaWMuCiAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICBjb250ZW50czogJ2NhcmRhbm8uZXBvY2gtdmFsaWRhdGlvbi5iZW5jaG1hcmsnCiAgICAgICAgLSAtIHRhZzogQ29udGFpbnMKICAgICAgICAgICAgY29udGVudHM6IGRpZmYuUlRTLmNwdU5zLnRpbWVkLgogICAgICAtIC0gdGFnOiBTdGFydHNXaXRoCiAgICAgICAgICBjb250ZW50czogJyNla2d2aWV3LiNhZ2dyZWdhdGlvbi5jYXJkYW5vLmVwb2NoLXZhbGlkYXRpb24uYmVuY2htYXJrJwogICAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICAgIGNvbnRlbnRzOiBkaWZmLlJUUy5nY051bS50aW1lZC4KICAgICAgc3VidHJhY2U6IEZpbHRlclRyYWNlCiAgICAnY2FyZGFuby5lcG9jaC12YWxpZGF0aW9uLnV0eG8tc3RhdHMnOgogICAgICAjIENoYW5nZSB0aGUgYHN1YnRyYWNlYCB2YWx1ZSB0byBgTmV1dHJhbGAgaW4gb3JkZXIgdG8gbG9nCiAgICAgICMgYFVUeE9gLXJlbGF0ZWQgbWVzc2FnZXMgZHVyaW5nIGVwb2NoIHZhbGlkYXRpb24uCiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnI21lc3NhZ2Vjb3VudGVycy5hZ2dyZWdhdGlvbic6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnI21lc3NhZ2Vjb3VudGVycy5la2d2aWV3JzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICcjbWVzc2FnZWNvdW50ZXJzLnN3aXRjaGJvYXJkJzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICcjbWVzc2FnZWNvdW50ZXJzLmthdGlwJzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICcjbWVzc2FnZWNvdW50ZXJzLm1vbml0b3JpbmcnOgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogICAgJ2NhcmRhbm8uI21lc3NhZ2Vjb3VudGVycy5hZ2dyZWdhdGlvbic6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnY2FyZGFuby4jbWVzc2FnZWNvdW50ZXJzLmVrZ3ZpZXcnOgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogICAgJ2NhcmRhbm8uI21lc3NhZ2Vjb3VudGVycy5zd2l0Y2hib2FyZCc6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnY2FyZGFuby4jbWVzc2FnZWNvdW50ZXJzLmthdGlwJzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICdjYXJkYW5vLiNtZXNzYWdlY291bnRlcnMubW9uaXRvcmluZyc6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgbWFwQmFja2VuZHM6CiAgICBjYXJkYW5vLmVwb2NoLXZhbGlkYXRpb24uYmVuY2htYXJrOgogICAgICAtIEFnZ3JlZ2F0aW9uQksKICAgICcjYWdncmVnYXRpb24uY2FyZGFuby5lcG9jaC12YWxpZGF0aW9uLmJlbmNobWFyayc6CiAgICAgIC0gRUtHVmlld0JLCiAgbWFwU2V2ZXJpdHk6CiAgICBkYi1zeW5jLW5vZGUuU3Vic2NyaXB0aW9uOiBFcnJvcgogICAgZGItc3luYy1ub2RlLk11eDogRXJyb3IKICAgIGRiLXN5bmMtbm9kZTogSW5mbw== | base64 --decode > /home/cardano/cardano-db-sync/config/preprod.yaml
RUN echo IyBFeHBsb3JlciBEQiBOb2RlIGNvbmZpZ3VyYXRpb24KCk5ldHdvcmtOYW1lOiBwcmV2aWV3CgpFbmFibGVMb2dNZXRyaWNzOiBGYWxzZQpFbmFibGVMb2dnaW5nOiBUcnVlCgpQcm90b2NvbDogQ2FyZGFubwoKIyBUaGUgY29uZmlnIGZpbGUgZm9yIHRoZSBub2RlIHdlIGFyZSBjb25uZWN0aW5nIHRvLiBJZiB0aGlzIGlzIG5vdCB0aGUgY29ycmVjdAojIGNvbmZpZywgaXQgd2lsbCBsaWtlbHkgbGVhZCB0byBkYi1zeW5jIHRocm93aW5nIHVwIHdlaXJkIGVycm9yIG1lc3NhZ2VzIGZyb20KIyB0aGUgY29uc2Vuc3VzIGxheWVyLgojIFRoZSBwYXRoIHRvIHRoZSBub2RlIGNvbmZpZyBmaWxlIGlzIHJlbGF0aXZlIHRvIHRoaXMgY29uZmlnIGZpbGUuCk5vZGVDb25maWdGaWxlOiAvY2FyZGFuby1jb25maWd1cmF0aW9ucy9uZXR3b3JrL3ByZXZpZXcvY2FyZGFuby1ub2RlL2NvbmZpZy5qc29uCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIExvZ2dpbmcgY29uZmlndXJhdGlvbiBmb2xsb3dzLgoKIyBnbG9iYWwgZmlsdGVyOyBtZXNzYWdlcyBtdXN0IGhhdmUgYXQgbGVhc3QgdGhpcyBzZXZlcml0eSB0byBwYXNzOgptaW5TZXZlcml0eTogSW5mbwoKIyBnbG9iYWwgZmlsZSByb3RhdGlvbiBzZXR0aW5nczoKcm90YXRpb246CiAgcnBMb2dMaW1pdEJ5dGVzOiA1MDAwMDAwCiAgcnBLZWVwRmlsZXNOdW06ICAxMAogIHJwTWF4QWdlSG91cnM6ICAgMjQKCiMgdGhlc2UgYmFja2VuZHMgYXJlIGluaXRpYWxpemVkOgpzZXR1cEJhY2tlbmRzOgogIC0gQWdncmVnYXRpb25CSwogIC0gS2F0aXBCSwogICMgLSBFZGl0b3JCSwogICMgLSBFS0dWaWV3QksKCiMgaWYgbm90IGluZGljYXRlZCBvdGhlcndpc2UsIHRoZW4gbWVzc2FnZXMgYXJlIHBhc3NlZCB0byB0aGVzZSBiYWNrZW5kczoKZGVmYXVsdEJhY2tlbmRzOgogIC0gS2F0aXBCSwoKIyBpZiB3YW50ZWQsIHRoZSBHVUkgaXMgbGlzdGVuaW5nIG9uIHRoaXMgcG9ydDoKIyBoYXNHVUk6IDEyNzg3CgojIGlmIHdhbnRlZCwgdGhlIEVLRyBpbnRlcmZhY2UgaXMgbGlzdGVuaW5nIG9uIHRoaXMgcG9ydDoKIyBoYXNFS0c6IDEyNzg4CgojIGhlcmUgd2Ugc2V0IHVwIG91dHB1dHMgb2YgbG9nZ2luZyBpbiAna2F0aXAnOgpzZXR1cFNjcmliZXM6CiAgLSBzY0tpbmQ6IFN0ZG91dFNLCiAgICBzY05hbWU6IHN0ZG91dAogICAgc2NGb3JtYXQ6IFNjVGV4dAogICAgc2NSb3RhdGlvbjogbnVsbAoKIyBpZiBub3QgaW5kaWNhdGVkIG90aGVyd2lzZSwgdGhlbiBsb2cgb3V0cHV0IGlzIGRpcmVjdGVkIHRvIHRoaXM6CmRlZmF1bHRTY3JpYmVzOgogIC0gLSBTdGRvdXRTSwogICAgLSBzdGRvdXQKCiMgbW9yZSBvcHRpb25zIHdoaWNoIGNhbiBiZSBwYXNzZWQgYXMga2V5LXZhbHVlIHBhaXJzOgpvcHRpb25zOgogIGNmb2tleToKICAgIHZhbHVlOiAiUmVsZWFzZS0xLjAuMCIKICBtYXBTdWJ0cmFjZToKICAgIGJlbmNobWFyazoKICAgICAgY29udGVudHM6CiAgICAgICAgLSBHaGNSdHNTdGF0cwogICAgICAgIC0gTW9ub3RvbmljQ2xvY2sKICAgICAgc3VidHJhY2U6IE9ic2VydmFibGVUcmFjZQogICAgJyNla2d2aWV3JzoKICAgICAgY29udGVudHM6CiAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICBjb250ZW50czogJ2NhcmRhbm8uZXBvY2gtdmFsaWRhdGlvbi5iZW5jaG1hcmsnCiAgICAgICAgLSAtIHRhZzogQ29udGFpbnMKICAgICAgICAgICAgY29udGVudHM6IC5tb25vY2xvY2suYmFzaWMuCiAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICBjb250ZW50czogJ2NhcmRhbm8uZXBvY2gtdmFsaWRhdGlvbi5iZW5jaG1hcmsnCiAgICAgICAgLSAtIHRhZzogQ29udGFpbnMKICAgICAgICAgICAgY29udGVudHM6IGRpZmYuUlRTLmNwdU5zLnRpbWVkLgogICAgICAtIC0gdGFnOiBTdGFydHNXaXRoCiAgICAgICAgICBjb250ZW50czogJyNla2d2aWV3LiNhZ2dyZWdhdGlvbi5jYXJkYW5vLmVwb2NoLXZhbGlkYXRpb24uYmVuY2htYXJrJwogICAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICAgIGNvbnRlbnRzOiBkaWZmLlJUUy5nY051bS50aW1lZC4KICAgICAgc3VidHJhY2U6IEZpbHRlclRyYWNlCiAgICAnY2FyZGFuby5lcG9jaC12YWxpZGF0aW9uLnV0eG8tc3RhdHMnOgogICAgICAjIENoYW5nZSB0aGUgYHN1YnRyYWNlYCB2YWx1ZSB0byBgTmV1dHJhbGAgaW4gb3JkZXIgdG8gbG9nCiAgICAgICMgYFVUeE9gLXJlbGF0ZWQgbWVzc2FnZXMgZHVyaW5nIGVwb2NoIHZhbGlkYXRpb24uCiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnI21lc3NhZ2Vjb3VudGVycy5hZ2dyZWdhdGlvbic6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnI21lc3NhZ2Vjb3VudGVycy5la2d2aWV3JzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICcjbWVzc2FnZWNvdW50ZXJzLnN3aXRjaGJvYXJkJzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICcjbWVzc2FnZWNvdW50ZXJzLmthdGlwJzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICcjbWVzc2FnZWNvdW50ZXJzLm1vbml0b3JpbmcnOgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogICAgJ2NhcmRhbm8uI21lc3NhZ2Vjb3VudGVycy5hZ2dyZWdhdGlvbic6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnY2FyZGFuby4jbWVzc2FnZWNvdW50ZXJzLmVrZ3ZpZXcnOgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogICAgJ2NhcmRhbm8uI21lc3NhZ2Vjb3VudGVycy5zd2l0Y2hib2FyZCc6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnY2FyZGFuby4jbWVzc2FnZWNvdW50ZXJzLmthdGlwJzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICdjYXJkYW5vLiNtZXNzYWdlY291bnRlcnMubW9uaXRvcmluZyc6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgbWFwQmFja2VuZHM6CiAgICBjYXJkYW5vLmVwb2NoLXZhbGlkYXRpb24uYmVuY2htYXJrOgogICAgICAtIEFnZ3JlZ2F0aW9uQksKICAgICcjYWdncmVnYXRpb24uY2FyZGFuby5lcG9jaC12YWxpZGF0aW9uLmJlbmNobWFyayc6CiAgICAgIC0gRUtHVmlld0JLCiAgbWFwU2V2ZXJpdHk6CiAgICBkYi1zeW5jLW5vZGUuU3Vic2NyaXB0aW9uOiBFcnJvcgogICAgZGItc3luYy1ub2RlLk11eDogRXJyb3IKICAgIGRiLXN5bmMtbm9kZTogSW5mbw==  | base64 --decode > /home/cardano/cardano-db-sync/config/preview.yaml
RUN echo IyBFeHBsb3JlciBEQiBOb2RlIGNvbmZpZ3VyYXRpb24KCk5ldHdvcmtOYW1lOiBzYW5jaG9uZXQKCkVuYWJsZUxvZ01ldHJpY3M6IEZhbHNlCkVuYWJsZUxvZ2dpbmc6IFRydWUKClByb3RvY29sOiBDYXJkYW5vCgojIFRoZSBjb25maWcgZmlsZSBmb3IgdGhlIG5vZGUgd2UgYXJlIGNvbm5lY3RpbmcgdG8uIElmIHRoaXMgaXMgbm90IHRoZSBjb3JyZWN0CiMgY29uZmlnLCBpdCB3aWxsIGxpa2VseSBsZWFkIHRvIGRiLXN5bmMgdGhyb3dpbmcgdXAgd2VpcmQgZXJyb3IgbWVzc2FnZXMgZnJvbQojIHRoZSBjb25zZW5zdXMgbGF5ZXIuCiMgVGhlIHBhdGggdG8gdGhlIG5vZGUgY29uZmlnIGZpbGUgaXMgcmVsYXRpdmUgdG8gdGhpcyBjb25maWcgZmlsZS4KTm9kZUNvbmZpZ0ZpbGU6IC9jYXJkYW5vLWNvbmZpZ3VyYXRpb25zL25ldHdvcmsvc2FuY2hvbmV0L2NhcmRhbm8tbm9kZS9jb25maWcuanNvbgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBMb2dnaW5nIGNvbmZpZ3VyYXRpb24gZm9sbG93cy4KCiMgZ2xvYmFsIGZpbHRlcjsgbWVzc2FnZXMgbXVzdCBoYXZlIGF0IGxlYXN0IHRoaXMgc2V2ZXJpdHkgdG8gcGFzczoKbWluU2V2ZXJpdHk6IEluZm8KCiMgZ2xvYmFsIGZpbGUgcm90YXRpb24gc2V0dGluZ3M6CnJvdGF0aW9uOgogIHJwTG9nTGltaXRCeXRlczogNTAwMDAwMAogIHJwS2VlcEZpbGVzTnVtOiAgMTAKICBycE1heEFnZUhvdXJzOiAgIDI0CgojIHRoZXNlIGJhY2tlbmRzIGFyZSBpbml0aWFsaXplZDoKc2V0dXBCYWNrZW5kczoKICAtIEFnZ3JlZ2F0aW9uQksKICAtIEthdGlwQksKICAjIC0gRWRpdG9yQksKICAjIC0gRUtHVmlld0JLCgojIGlmIG5vdCBpbmRpY2F0ZWQgb3RoZXJ3aXNlLCB0aGVuIG1lc3NhZ2VzIGFyZSBwYXNzZWQgdG8gdGhlc2UgYmFja2VuZHM6CmRlZmF1bHRCYWNrZW5kczoKICAtIEthdGlwQksKCiMgaWYgd2FudGVkLCB0aGUgR1VJIGlzIGxpc3RlbmluZyBvbiB0aGlzIHBvcnQ6CiMgaGFzR1VJOiAxMjc4NwoKIyBpZiB3YW50ZWQsIHRoZSBFS0cgaW50ZXJmYWNlIGlzIGxpc3RlbmluZyBvbiB0aGlzIHBvcnQ6CiMgaGFzRUtHOiAxMjc4OAoKIyBoZXJlIHdlIHNldCB1cCBvdXRwdXRzIG9mIGxvZ2dpbmcgaW4gJ2thdGlwJzoKc2V0dXBTY3JpYmVzOgogIC0gc2NLaW5kOiBTdGRvdXRTSwogICAgc2NOYW1lOiBzdGRvdXQKICAgIHNjRm9ybWF0OiBTY1RleHQKICAgIHNjUm90YXRpb246IG51bGwKCiMgaWYgbm90IGluZGljYXRlZCBvdGhlcndpc2UsIHRoZW4gbG9nIG91dHB1dCBpcyBkaXJlY3RlZCB0byB0aGlzOgpkZWZhdWx0U2NyaWJlczoKICAtIC0gU3Rkb3V0U0sKICAgIC0gc3Rkb3V0CgojIG1vcmUgb3B0aW9ucyB3aGljaCBjYW4gYmUgcGFzc2VkIGFzIGtleS12YWx1ZSBwYWlyczoKb3B0aW9uczoKICBjZm9rZXk6CiAgICB2YWx1ZTogIlJlbGVhc2UtMS4wLjAiCiAgbWFwU3VidHJhY2U6CiAgICBiZW5jaG1hcms6CiAgICAgIGNvbnRlbnRzOgogICAgICAgIC0gR2hjUnRzU3RhdHMKICAgICAgICAtIE1vbm90b25pY0Nsb2NrCiAgICAgIHN1YnRyYWNlOiBPYnNlcnZhYmxlVHJhY2UKICAgICcjZWtndmlldyc6CiAgICAgIGNvbnRlbnRzOgogICAgICAtIC0gdGFnOiBDb250YWlucwogICAgICAgICAgY29udGVudHM6ICdjYXJkYW5vLmVwb2NoLXZhbGlkYXRpb24uYmVuY2htYXJrJwogICAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICAgIGNvbnRlbnRzOiAubW9ub2Nsb2NrLmJhc2ljLgogICAgICAtIC0gdGFnOiBDb250YWlucwogICAgICAgICAgY29udGVudHM6ICdjYXJkYW5vLmVwb2NoLXZhbGlkYXRpb24uYmVuY2htYXJrJwogICAgICAgIC0gLSB0YWc6IENvbnRhaW5zCiAgICAgICAgICAgIGNvbnRlbnRzOiBkaWZmLlJUUy5jcHVOcy50aW1lZC4KICAgICAgLSAtIHRhZzogU3RhcnRzV2l0aAogICAgICAgICAgY29udGVudHM6ICcjZWtndmlldy4jYWdncmVnYXRpb24uY2FyZGFuby5lcG9jaC12YWxpZGF0aW9uLmJlbmNobWFyaycKICAgICAgICAtIC0gdGFnOiBDb250YWlucwogICAgICAgICAgICBjb250ZW50czogZGlmZi5SVFMuZ2NOdW0udGltZWQuCiAgICAgIHN1YnRyYWNlOiBGaWx0ZXJUcmFjZQogICAgJ2NhcmRhbm8uZXBvY2gtdmFsaWRhdGlvbi51dHhvLXN0YXRzJzoKICAgICAgIyBDaGFuZ2UgdGhlIGBzdWJ0cmFjZWAgdmFsdWUgdG8gYE5ldXRyYWxgIGluIG9yZGVyIHRvIGxvZwogICAgICAjIGBVVHhPYC1yZWxhdGVkIG1lc3NhZ2VzIGR1cmluZyBlcG9jaCB2YWxpZGF0aW9uLgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogICAgJyNtZXNzYWdlY291bnRlcnMuYWdncmVnYXRpb24nOgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogICAgJyNtZXNzYWdlY291bnRlcnMuZWtndmlldyc6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnI21lc3NhZ2Vjb3VudGVycy5zd2l0Y2hib2FyZCc6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnI21lc3NhZ2Vjb3VudGVycy5rYXRpcCc6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnI21lc3NhZ2Vjb3VudGVycy5tb25pdG9yaW5nJzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICdjYXJkYW5vLiNtZXNzYWdlY291bnRlcnMuYWdncmVnYXRpb24nOgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogICAgJ2NhcmRhbm8uI21lc3NhZ2Vjb3VudGVycy5la2d2aWV3JzoKICAgICAgc3VidHJhY2U6IE5vVHJhY2UKICAgICdjYXJkYW5vLiNtZXNzYWdlY291bnRlcnMuc3dpdGNoYm9hcmQnOgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogICAgJ2NhcmRhbm8uI21lc3NhZ2Vjb3VudGVycy5rYXRpcCc6CiAgICAgIHN1YnRyYWNlOiBOb1RyYWNlCiAgICAnY2FyZGFuby4jbWVzc2FnZWNvdW50ZXJzLm1vbml0b3JpbmcnOgogICAgICBzdWJ0cmFjZTogTm9UcmFjZQogIG1hcEJhY2tlbmRzOgogICAgY2FyZGFuby5lcG9jaC12YWxpZGF0aW9uLmJlbmNobWFyazoKICAgICAgLSBBZ2dyZWdhdGlvbkJLCiAgICAnI2FnZ3JlZ2F0aW9uLmNhcmRhbm8uZXBvY2gtdmFsaWRhdGlvbi5iZW5jaG1hcmsnOgogICAgICAtIEVLR1ZpZXdCSwogIG1hcFNldmVyaXR5OgogICAgZGItc3luYy1ub2RlLlN1YnNjcmlwdGlvbjogRXJyb3IKICAgIGRiLXN5bmMtbm9kZS5NdXg6IEVycm9yCiAgICBkYi1zeW5jLW5vZGU6IEluZm8=  | base64 --decode > /home/cardano/cardano-db-sync/config/sanchonet.yaml
WORKDIR /home/cardano
RUN chown -R 1001:1001 /home/cardano
RUN chown -R 1001:1001 /home/cardano/cardano-db-sync
RUN chown -R 1001:1001 /cardano-configurations
RUN mkdir -p /home/cardano/cdbsync
RUN mkdir -p /home/cardano/ipc
RUN chown -R 1001:1001 /home/cardano/cdbsync
RUN chown -R 1001:1001 /home/cardano/ipc
USER 1001:1001
ENTRYPOINT cd /home/cardano && echo "$POSTGRES_HOST:$POSTGRES_PORT:$POSTGRES_DB:$POSTGRES_USER:$POSTGRES_PASS" > pgpass && chmod 600 pgpass && . /home/cardano/getConf.sh && PGPASSFILE=./pgpass cardano-db-sync --state-dir /home/cardano/cdbsync --schema-dir /home/cardano/cardano-db-sync/schema/ --config "$CONF" --socket-path /home/cardano/ipc/node.socket
